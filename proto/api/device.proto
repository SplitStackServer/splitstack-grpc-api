syntax = "proto3";

package api;

option go_package = "github.com/SplitStackServer/splitstack-grpc-api/api";
option java_package = "io.splitstack.api";
option java_multiple_files = true;
option java_outer_classname = "DeviceProto";
option csharp_namespace = "SplitStackServer.Api";
option php_namespace = "SplitStackServer\\Api";
option php_metadata_namespace = "GPBMetadata\\SplitStackServer\\Api";


import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

import "api/common.proto";
import "common/common.proto";
import "common/metrics.proto";

// DeviceService is the service providing API methods for managing devices.
service DeviceService {



  // Create the given device.
  rpc CreateDevice(CreateDeviceRequest) returns (CreateDeviceResponse) {
    option (google.api.http) = {
      post : "/api/devices"
      body : "*"
    };
  }

  // Get returns the device for the given ID.
  rpc GetDevice(GetDeviceRequest) returns (GetDeviceResponse) {
    option (google.api.http) = {
      get : "/api/devices/{id}"
    };
  }

  // Update the given device.
  rpc UpdateDevice(UpdateDeviceRequest) returns (UpdateDeviceResponse) {
    option (google.api.http) = {
      put : "/api/devices/{id}"
      body : "*"
    };
  }

  // Delete the device with the given ID.
  rpc DeleteDevice(DeleteDeviceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete : "/api/devices/{id}"
    };
  }


  // Get the list of devices.
  rpc ListDevices(ListDevicesRequest) returns (ListDevicesResponse) {
    option (google.api.http) = {
      get : "/api/devices"
    };
  }

  // GetMetrics returns the device metrics.
  // Note that this requires a device-profile with codec and measurements
  // configured.
  rpc GetDeviceMetrics(GetDeviceMetricsRequest) returns (GetDeviceMetricsResponse) {
    option (google.api.http) = {
      get : "/api/devices/{id}/metrics"
    };
  }

  // GetLinkMetrics returns the device link metrics.
  // This includes uplinks, downlinks, RSSI, SNR, etc...
  rpc GetDeviceLinkMetrics(GetDeviceLinkMetricsRequest)
      returns (GetDeviceLinkMetricsResponse) {
    option (google.api.http) = {
      get : "/api/devices/{id}/link-metrics"
    };
  }

}

message Device {
  // Device ID (UUID).
  string id = 1;

  // Device EUI (EUI64).
  string eui = 2;

  // Application ID (UUID).
  string application_id = 3;

  // Device-profile ID (UUID).
  optional string device_profile_id = 4;

  // Name.
  string name = 5;

  // Description.
  optional string description = 6;

  // Location.
  optional common.GeoLocation location = 7;

  // Device is disabled.
  bool is_disabled = 8;

  // Variables (user defined).
  // These variables can be used together with integrations to store tokens /
  // secrets that must be configured per device. These variables are not
  // exposed in the event payloads.
  optional common.Tags variables = 9;

  // Tags (user defined).
  // These tags can be used to add additional information to the device.
  // These tags are exposed in all the integration events.
  optional common.Tags tags = 10;


}


message DeviceListItem {
  // Device ID (UUID).
  string id = 1;

  // Device EUI (EUI64).
  string eui = 2;

  // Created at timestamp.
  google.protobuf.Timestamp created_at = 3;

  // Last update timestamp.
  google.protobuf.Timestamp updated_at = 4;

  // Last seen at timestamp.
  optional google.protobuf.Timestamp last_seen_at = 5;

  // Name.
  string name = 6;

  // Description.
  optional string description = 7;

  // Device-profile ID (UUID).
  optional string device_profile_id = 8;

  // Device-profile name.
  optional string device_profile_name = 9;

  // Application ID (UUID).
  string application_id = 10;

  // Application Name.
  string application_name = 11;

  // Tags (user defined).
  // These tags can be used to add additional information to the device.
  // These tags are exposed in all the integration events.
  optional common.Tags tags = 12;
}


message CreateDeviceRequest {
  // Device EUI (EUI64).
  string eui = 2;

  // Application ID (UUID).
  string application_id = 3;

  // Device-profile ID (UUID).
  optional string device_profile_id = 4;

  // Name.
  string name = 5;

  // Description.
  optional string description = 6;

  // Location.
  optional common.GeoLocation location = 7;

  // Device is disabled.
  bool is_disabled = 8;

  // Variables (user defined).
  // These variables can be used together with integrations to store tokens /
  // secrets that must be configured per device. These variables are not
  // exposed in the event payloads.
  optional common.Tags variables = 9;

  // Tags (user defined).
  // These tags can be used to add additional information to the device.
  // These tags are exposed in all the integration events.
  optional common.Tags tags = 10;
}

message CreateDeviceResponse {
  // Device object.
  Device device = 1;

  // Created at timestamp.
  google.protobuf.Timestamp created_at = 2;
}

message GetDeviceRequest {
  // Device ID (UUID).
  string id = 1;
}

message GetDeviceResponse {
  // Device object.
  Device device = 1;

  // Created at timestamp.
  google.protobuf.Timestamp created_at = 2;

  // Last update timestamp.
  google.protobuf.Timestamp updated_at = 3;

  // Last seen at timestamp.
  google.protobuf.Timestamp last_seen_at = 4;
}

message UpdateDeviceRequest {
  // Device ID (UUID).
  string id = 1;

  // Application ID (UUID).
  optional string application_id = 3;

  // Device-profile ID (UUID).
  optional string device_profile_id = 4;

  // Name.
  optional string name = 5;

  // Description.
  optional string description = 6;

  // Location.
  optional common.GeoLocation location = 7;

  // Device is disabled.
  optional bool is_disabled = 8;

  // Variables (user defined).
  // These variables can be used together with integrations to store tokens /
  // secrets that must be configured per device. These variables are not
  // exposed in the event payloads.
  optional common.Tags variables = 9;

  // Tags (user defined).
  // These tags can be used to add additional information to the device.
  // These tags are exposed in all the integration events.
  optional common.Tags tags = 10;
}

message UpdateDeviceResponse {
    // Device object.
    Device device = 1;

	// Created at timestamp.
	google.protobuf.Timestamp created_at = 2;

	// Last update timestamp.
	google.protobuf.Timestamp updated_at = 3;
}


message DeleteDeviceRequest {
  // Device ID (UUID).
  string id = 1;
}

message ListDevicesRequest {
    // Pagination. Defaults to 100 objects at page index 0.
    Paginator paginator = 1;

    // If set, the given string will be used to search on name (optional).
    optional string search_name = 2;

    // Application ID (UUID) to filter devices on.
    // Leave blank to show devices of all applications of the tenant.
    optional string application_id = 3;

    // Tenant ID (UUID) to filter devices on.
    // Only applies to global admin users, leave blank for regular users.
    // This will show all devices that belong to applications of a tenant.
    optional string tenant_id = 4;

    // Tags to filter devices on.
    optional common.Tags tags = 5;

    // Device-profile ID (UUID) to filter devices on.
    optional string device_profile_id = 6;


    enum OrderBy {
        NAME = 0;
        EUI = 1;
        LAST_SEEN_AT = 2;
        CREATED_AT = 3;  
    }

    // If set, the given value will be used to sort by (optional).
    OrderBy order_by = 7;

    // If set, the sorting direction will be decending (default = ascending) (optional).
    bool order_by_desc = 8;


}

message ListDevicesResponse {
    // Pagination.
    Pagination pagination = 1;

    // Result-set.
    repeated DeviceListItem result = 2;
}



message GetDeviceMetricsRequest {
  // Device ID (UUID).
  string id = 1;

  // Interval start timestamp.
  google.protobuf.Timestamp start = 2;

  // Interval end timestamp.
  google.protobuf.Timestamp end = 3;

  // Aggregation.
  common.Aggregation aggregation = 4;
}

message GetDeviceMetricsResponse {
  map<string, common.Metric> metrics = 1;
}


message GetDeviceLinkMetricsRequest {
  // Device ID (UUID).
  string id = 1;

  // Interval start timestamp.
  google.protobuf.Timestamp start = 2;

  // Interval end timestamp.
  google.protobuf.Timestamp end = 3;

  // Aggregation.
  common.Aggregation aggregation = 4;
}

message GetDeviceLinkMetricsResponse {
  // Packets received from the device.
  common.Metric rx_packets = 1;

  // RSSI (as reported by the gateway(s)).
  common.Metric gw_rssi = 2;

  // SNR (as reported by the gateway(s)).
  common.Metric gw_snr = 3;

  // Packets received by frequency.
  common.Metric rx_packets_per_freq = 4;

  // Packets received by DR.
  common.Metric rx_packets_per_dr = 5;

  // Errors.
  common.Metric errors = 6;
}
