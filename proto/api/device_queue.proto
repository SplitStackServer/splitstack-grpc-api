syntax = "proto3";

package api;

option go_package = "github.com/SplitStackServer/splitstack-grpc-api/go/api";
option java_package = "io.splitstack.api";
option java_multiple_files = true;
option java_outer_classname = "DeviceQueueProto";
option csharp_namespace = "SplitStackServer.Api";
option php_namespace = "SplitStackServer\\Api";
option php_metadata_namespace = "GPBMetadata\\SplitStackServer\\Api";


import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/empty.proto";

import "common/common.proto";
import "api/common.proto";

// DeviceQueueService is the service providing API methods for managing device downlink queues.
service DeviceQueueService {


  // Enqueue adds the given item to the downlink queue of the device.
  rpc Enqueue(EnqueueDeviceQueueItemRequest)
      returns (EnqueueDeviceQueueItemResponse) {
    option (google.api.http) = {
      post : "/api/devices/{id}/queue"
      body : "*"
    };
  }

  // Revoke removes the given item from the downlink queue of the device.
  rpc Revoke(RevokeDeviceQueueItemRequest)
      returns (RevokeDeviceQueueItemResponse) {
    option (google.api.http) = {
      post : "/api/devices/{device_id}/queue/{queue_id}"
      body : "*"
    };
  }


  // ClearQueue removes all entries from the downlink queue of the device.
  rpc ClearQueue(ClearDeviceQueueRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete : "/api/devices/{id}/queue"
    };
  }

  // GetQueue returns the downlink queue of the device.
  rpc GetQueue(GetDeviceQueueItemsRequest)
      returns (GetDeviceQueueItemsResponse) {
    option (google.api.http) = {
      get : "/api/devices/{id}/queue"
    };
  }

}


message DeviceQueueItem {
  // ID (UUID).
  // This is automatically generated on enqueue.
  string id = 1;

  // Device EUI (EUI64).
  string eui = 2;

  // Confirmed.
  bool confirmed = 3;

  // FPort (must be > 0).
  uint32 f_port = 4;

  // Data.
  // Or use the json_object field when a codec has been configured.
  bytes data = 5;

  // Only use this when a codec has been configured that can encode this
  // object to bytes.
  google.protobuf.Struct object = 6;

  // Is pending.
  // This is set by ChirpStack to true when the downlink is pending (e.g. it
  // has been sent, but a confirmation is still pending).
  bool is_pending = 7;

  // Downlink frame-counter.
  // Do not set this for plain-text data payloads. It will be automatically set
  // by ChirpStack when the payload has been sent as downlink.
  uint32 f_cnt_down = 8;

  // Is encrypted.
  // This must be set to true if the end-application has already encrypted
  // the data payload. In this case, the f_cnt_down field must be set to
  // the corresponding frame-counter which has been used during the encryption.
  bool is_encrypted = 9;

  // Expires at (optional).
  // Expired queue-items will be automatically removed from the queue.
  google.protobuf.Timestamp expires_at = 10;
}

message EnqueueDeviceQueueItemRequest { 
  DeviceQueueItem queue_item = 1; 
}

message EnqueueDeviceQueueItemResponse {
  // ID (UUID).
  string id = 1;
}

message RevokeDeviceQueueItemRequest { 
  // Device ID (UUID).
  string device_id = 1;

  // Queue ID (UUID).
  string queue_id = 2;
}

message RevokeDeviceQueueItemResponse {
  // Device ID (UUID).
  string device_id = 1;

  // Queue ID (UUID).
  string queue_id = 2;
}



message ClearDeviceQueueRequest {
  // Device EUI (EUI64).
  string eui = 1;
}

message GetDeviceQueueItemsRequest {
  // Device EUI (EUI64).
  string eui = 1;

  // Return only the count, not the result-set.
  bool count_only = 2;
}

message GetDeviceQueueItemsResponse {
  // Total number of queue items.
  uint32 total_count = 1;

  // Result-set.
  repeated DeviceQueueItem result = 2;
}

message ClearDevNoncesRequest {
  // Device EUI (EUI64).
  string eui = 1;
}

message GetDeviceNextFCntDownRequest {
  // Device EUI (EUI64).
  string eui = 1;
}

message GetDeviceNextFCntDownResponse {
  // FCntDown.
  uint32 f_cnt_down = 1;
}
