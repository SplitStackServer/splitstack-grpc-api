syntax = "proto3";

package api;

option go_package = "github.com/SplitStackServer/splitstack-grpc-api/go/api";
option java_package = "io.splitstack.api";
option java_multiple_files = true;
option java_outer_classname = "BasestationProto";
option csharp_namespace = "SplitStackServer.Api";
option php_namespace = "SplitStackServer\\Api";
option php_metadata_namespace = "GPBMetadata\\SplitStackServer\\Api";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

import "api/common.proto";
import "common/common.proto";
import "common/metrics.proto";

// BasestationService is the service providing API methods for managing basestations.
service BasestationService {
    // Create creates the given gateway.
    rpc CreateBasestation(CreateBasestationRequest) returns (CreateBasestationResponse) {
        option(google.api.http) = {
            post: "/api/basestations"
            body: "*"
        };
    }

    // Get returns the gateway for the given Basestation ID.
    rpc GetBasestation(GetBasestationRequest) returns (GetBasestationResponse) {
        option(google.api.http) = {
            get: "/api/basestations/{id}"
        };
    }

    // Update updates the given gateway.
    rpc UpdateBasestation(UpdateBasestationRequest) returns (UpdateBasestationResponse) {
        option(google.api.http) = {
            put: "/api/basestations/{id}"
            body: "*"
        };
    }

    // Delete deletes the gateway matching the given Basestation ID.
    rpc DeleteBasestation(DeleteBasestationRequest) returns (google.protobuf.Empty) {
        option(google.api.http) = {
            delete: "/api/basestations/{id}"
        };
    }

    // Get the list of basestations.
    rpc ListBasestations(ListBasestationsRequest) returns (ListBasestationsResponse) {
        option(google.api.http) = {
            get: "/api/basestations"
        };
    }

    // Generate client-certificate for the gateway.
    rpc GenerateBasestationClientCertificate(GenerateBasestationClientCertificateRequest) returns (GenerateBasestationClientCertificateResponse) {
        option(google.api.http) = {
            post: "/api/basestations/{id}/certificate"
        };
    }

    // GetMetrics returns the gateway metrics.
    rpc GetBasestationMetrics(GetBasestationMetricsRequest) returns (GetBasestationMetricsResponse) {
        option(google.api.http) = {
            get: "/api/basestations/{id}/metrics"
        };
    }
}

enum BasestationState {
    // The gateway has never sent any data.
    NEVER_SEEN = 0;

    // Online.
    ONLINE = 1;

    // Offline.
    OFFLINE = 2;

    // Inactive.
    INACTIVE = 3;

}

message Basestation {
    // Basestation ID (UUID).
    string id = 1;

    // Basestation EUI64.
    string eui = 2;

    // Name.
    string name = 3;

    // Description.
    optional string description = 4;

    // Basestation location.
    optional common.GeoLocation location = 5;

    // Basestation metadata (set on connection).
    optional BasestationMetadata metadata = 6;

    bool use_gps_location = 7;

    bool variable_mac_support = 8;

    // Tags.
    optional common.Tags tags = 9;

    // Basestation state.
    BasestationState state = 10;

}

message BasestationListItem {
    // Tenant ID.
    string tenant_id = 1;

    // Basestation ID (UUID).
    string basestation_id = 2;

    // Basestation EUI64.
    string eui = 3;

    // Name.
    string name = 4;

    // Description.
    optional string description = 5;

    // Location.
    optional common.GeoLocation location = 6;

    // Basestation metadata (set on connection).
    optional BasestationMetadata metadata = 7;

    // Created at timestamp.
    google.protobuf.Timestamp created_at = 8;

    // Last update timestamp.
    google.protobuf.Timestamp updated_at = 9;

    // Last seen at timestamp.
    optional google.protobuf.Timestamp last_seen_at = 10;

    bool variable_mac_support = 11;

    // Basestation state.
    BasestationState state = 12;
}

message BasestationMetadata {
    // Vendor.
    optional string vendor = 1;

    // Model.
    optional string model = 2;

    // Alias.
    optional string alias = 3;

    // Software version.
    optional string sw_version = 4;
}

message CreateBasestationRequest {
    // Tenant ID.
    string tenant_id = 1;

    // Basestation EUI64.
    string eui = 2;

    // Name (defaults to EUI).
    optional string name = 3;

    // Description.
    optional string description = 4;

    // Location.
    optional common.GeoLocation location = 5;

    // Use location data provided by the basestation.
    bool use_gps_location = 6;

    // Tags.
    optional common.Tags tags = 8;
}

message CreateBasestationResponse {
    // Created Basestation object.
    Basestation basestation = 1;

    // Created at timestamp.
    google.protobuf.Timestamp created_at = 2;

}

message GetBasestationRequest {
    // Basestation ID (UUID).
    string id = 1;
}

message GetBasestationResponse {
    // Basestation object.
    Basestation basestation = 1;

	// Created at timestamp.
	google.protobuf.Timestamp created_at = 2;

	// Last update timestamp.
	google.protobuf.Timestamp updated_at = 3;

    // Last seen at timestamp.
    optional google.protobuf.Timestamp last_seen_at = 4;
}

message UpdateBasestationRequest {
    // Basestation ID (UUID).
    string id = 1;

    // Name.
    optional string name = 3;

    // Description.
    optional string description = 4;

    // Location.
    optional common.GeoLocation location = 5;

    // Use location data provided by the basestation.
    optional bool use_gps_location = 6;

    // Tags.
    optional common.Tags tags = 8;

}

message UpdateBasestationResponse {
    // Basestation object.
    Basestation basestation = 1;

	// Created at timestamp.
	google.protobuf.Timestamp created_at = 2;

	// Last update timestamp.
	google.protobuf.Timestamp updated_at = 3;
}



message DeleteBasestationRequest {
    // Basestation ID (UUID).
    string id = 1;
}

message ListBasestationsRequest {
    // Tenant ID (UUID) to filter basestations on.
    // To list all basestations as a global admin user, this field can be left blank.
    optional string tenant_id = 1;

    // Pagination. Defaults to 100 objects at page index 0.
    Paginator paginator = 2;

    // If set, the given string will be used to search on name (optional).
    optional string search_name = 3;

    // Tags to filter devices on.
    optional common.Tags tags = 4;


    enum OrderBy {
        NAME = 0;
        EUI = 1;
        LAST_SEEN_AT = 2;
        CREATED_AT = 3;  
    }

    // If set, the given value will be used to sort by (optional).
    OrderBy order_by = 6;

    // If set, the sorting direction will be decending (default = ascending) (optional).
    bool order_by_desc = 7;
}

message ListBasestationsResponse {
    // Pagination.
    Pagination pagination = 1;

    // Result-set.
    repeated BasestationListItem result = 2;
}

message GenerateBasestationClientCertificateRequest {
    // Basestation ID (UUID).
    string id = 1;
}

message GenerateBasestationClientCertificateResponse {
    // TLS certificate.
    string tls_cert = 1;

    // TLS key.
    string tls_key = 2;

    // CA certificate.
    string ca_cert = 3;

    // Expires at defines the expiration date of the certificate.
    google.protobuf.Timestamp expires_at = 4;
}

message GetBasestationMetricsRequest {
    // Basestation ID (UUID).
    string id = 1;

    // Interval start timestamp.
    google.protobuf.Timestamp start = 2;

    // Interval end timestamp.
    google.protobuf.Timestamp end = 3;

    // Aggregation.
    common.Aggregation aggregation = 4;
}

message GetBasestationMetricsResponse {
    // Basestation update in seconds.
    common.Metric uptime = 1;

    // CPU utilization, normalized to 1.0 for all cores.
    common.Metric cpu = 2;

    // Memory utilization, normalized to 1.0.
    common.Metric memory = 3;

    // System temperature in degree Celsius.
    common.Metric temp = 4;

    // Fraction of TX time, sliding window over one hour
    common.Metric duty_cycle = 5;

    // Number of received messages.
    common.Metric rx_count = 6;

    // Number of received variable mac messages.
    common.Metric rx_vm_count = 7;
}


