syntax = "proto3";

package bs;

option go_package = "github.com/SplitStackServer/splitstack-grpc-api/bs";
option java_package = "io.splitstack.api.bs";
option java_multiple_files = true;
option java_outer_classname = "BasestationProto";
option csharp_namespace = "SplitStackServer.Basestation";
option php_namespace = "SplitStackServer\\Basestation";
option php_metadata_namespace = "GPBMetadata\\SplitStackServer\\Basestation";

import "google/protobuf/timestamp.proto";
import "common/common.proto";

message BasestationState{
    // Basestation EUI, hex string
    string bs_eui = 1;

    enum ConnectionState {
        OFFLINE = 0;
        ONLINE = 1;
    }

    // ConnectionState
    ConnectionState state = 2;
}

message BasestationUplink {
    // Basestation EUI, hex string
    string bs_eui = 1;

    // Message timestamp.
    google.protobuf.Timestamp ts = 2;

    // ID of the operation
    int64 op_id = 3;

    // Message.
    oneof message {
        // Connect
        BasestationConnection con = 4;
        // Status
        BasestationStatus status = 5;
        // VM Status
        BasestationVariableMacStatus vm_status = 6;
        // Downlink result
        BasestationDownlinkResult dl_res = 7;
        // Downlink RX Status
        BasestationDownlinkRxStatus dl_rx_stat = 8;
        // Propagation ack
        BasestationPropagationAck prp_ack = 9;
    }
}

// Connect
message BasestationConnection {
    // Requested protocol version, major.minor.patch
    string version = 3;
    // True if Base Station is bidirectional
    bool bidi = 4;
    // Vendor of the Base Station, optional
    optional string vendor = 5;
    // Model of the Base Station, optional
    optional string model = 6;
    // Name of the Base Station, optional
    optional string name = 7;
    // Software version, optional
    optional string sw_version = 8;
    // Geographic location [Latitude, Longitude, Altitude], optional
    optional common.GeoLocation geo_location = 9;
}

// Status
message BasestationStatus {
    // Status code, using POSIX error numbers, 0 for ok
    uint32 status_code = 2;
    // Status message
    string status_msg = 3;
    // Unix UTC system time
    google.protobuf.Timestamp ts = 4;
    // Fraction of TX time, sliding window over one hour
    float duty_cycle = 5;
    // Geographic location [Latitude, Longitude, Altitude], optional
    optional common.GeoLocation geo_location = 6;
    // System uptime in seconds, optional
    optional uint64 uptime = 7;
    // System temperature in degree Celsius, optional
    optional double temp = 8;
    // CPU utilization, normalized to 1.0 for all cores, optional
    optional double cpu = 9;
    // Memory utilization, normalized to 1.0, optional
    optional double memory = 10;
}

// The VM Status represents a list of the activated MAC-Types.
//
// If the basestation does not support variable mac types, the error flag is set to true
// and the mac_types list is empty. The error_msg might contain additional information.
message BasestationVariableMacStatus{
    repeated uint32 mac_types = 1;
    // Some basestation might not support variable mac types
    bool error = 2;
    optional string error_msg = 3;
    // List of activated macTypes
}

enum DownlinkResultEnum {
    SENT = 0;
    EXPIRED = 1;
    INVALID = 2;
}

message BasestationDownlinkResult {
    // Endnode EUI, hex string
    string ep_eui = 1;
    // Assigned queue ID for reference
    uint64 dl_que_id = 3; 
    // Result of the downlink
    DownlinkResultEnum result = 4;
    // Unix UTC time of transmission, center of first subpacket, 64 bit, ns resolution, only if result is sent
    google.protobuf.Timestamp tx_time = 5;
    // End Point packet counter, only if result is “sent”
    uint32 ep_packet_cnt = 6;
}

message BasestationDownlinkRxStatus {
    // Endnode EUI, hex string
    string ep_eui = 1;
    // Basestation RX time.
    google.protobuf.Timestamp rx_time = 2;
    // Packet counter.
    uint32 packet_cnt = 3;
    // RSSI.
    double dl_rx_rssi = 4;
    // SNR.
    double dl_rx_snr = 5;
}

message BasestationPropagationAck {
    // Endnode EUI, hex string
    string ep_eui = 1;
   // Command ID (UUID)
    // string command_id = 2;

    enum State {
        ATTACH = 0;
        DETACH = 1;
    }

    // State
    State state = 3;

    bool success = 4;
}